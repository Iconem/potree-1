<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Potree Viewer</title>

	<link rel="stylesheet" type="text/css" href="../build/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="../libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="../libs/perfect-scrollbar/css/perfect-scrollbar.css">
	<link rel="stylesheet" type="text/css" href="../libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="../libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="../libs/jstree/themes/mixed/style.css">
</head>

<body>
	<script src="../libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="../libs/spectrum/spectrum.js"></script>
	<script src="../libs/perfect-scrollbar/js/perfect-scrollbar.jquery.js"></script>
	<script src="../libs/jquery-ui/jquery-ui.min.js"></script>
	<script src="../libs/three.js/build/three.min.js"></script>
	<script src="../libs/other/BinaryHeap.js"></script>
	<script src="../libs/tween/tween.min.js"></script>
	<script src="../libs/d3/d3.js"></script>
	<script src="../libs/proj4/proj4.js"></script>
	<script src="../libs/openlayers3/ol.js"></script>
	<script src="../libs/i18next/i18next.js"></script>
	<script src="../libs/jstree/jstree.js"></script>
	<script src="../build/potree/potree.js"></script>
	<script src="../libs/plasio/js/laslaz.js"></script>
	
	<!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
	<!-- INCLUDE SETTINGS HERE -->
	
	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area"></div>
		<div id="potree_sidebar_container"> </div>
	</div>
	
	
	<div style="position: absolute; right: 10px; top: 10px; z-index: 100; font-weight: bold; color: white; font-size: 40px; ">
		<div style="padding: 10px;" onclick="addPtcAndDownsamplingObjs(datasetIdx++)">⬆</div>
		<div style=" padding: 10px;" onclick="addPtcAndDownsamplingObjs(--datasetIdx)">⬇</div>
	</div>
	<div style="position: absolute; right: 10px; top: 175px; z-index: 100; color: white; font-size: 14px; width: 200px;">
		<span>Downsampling Width:</span> <span id="lblDownsamplingWidth">X</span> 
		<div id="sldDownsamplingWidth" class="ui-slider ui-corner-all ui-slider-horizontal ui-widget ui-widget-content">
			<span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default" style="left: 100%;"></span></div>
	</div>
	<div style="position: absolute; right: 10px; top: 225px; z-index: 100; color: white; font-size: 14px; width: 200px;">
		<span>Downsampling Start Width:</span> <span id="lblDownsamplingWidth0">X</span> 
		<div id="sldDownsamplingWidthStart" class="ui-slider ui-corner-all ui-slider-horizontal ui-widget ui-widget-content">
			<span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default" style="left: 100%;"></span></div>
	</div>
	<div style="position: absolute; right: 10px; top: 275px; z-index: 100; ">
		<button style="padding: 10px;" onclick="switchDebugShaderState()">SWITCH DEBUG SHADER STATE</div>
	</div>
		
		
	<script>

		var datasetIdx = 2;
		$('#sldDownsamplingWidth').slider({
			value: 1,
			min: -2,
			max: 3,
			step: 0.01,
			slide: (event, ui) => { 
				width = Math.pow(10, ui.value);
				$('#lblDownsamplingWidth')[0].innerHTML = width.toFixed(2);
				for (let p of viewer.scene.pointclouds) {
					p.material.downsamplingWidth = width;
                }
			}
		});
		var datasetIdx = 2;
		$('#sldDownsamplingWidthStart').slider({
			value: -2,
			min: -2,
			max: 3,
			step: 0.01,
			slide: (event, ui) => { 
				width = Math.pow(10, ui.value);
				$('#lblDownsamplingWidth0')[0].innerHTML = width.toFixed(2);
				for (let p of viewer.scene.pointclouds) {
					p.material.downsamplingWidth_0 = width;
                }
			}
		});

		function add_potree_viewer() {
			window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
			viewer.setEDLEnabled(true);
			viewer.setFOV(60);
			viewer.setPointBudget(10*1000*1000);
			viewer.setBackground("gradient"); // ["skybox", "gradient", "black", "white"];
			viewer.loadSettingsFromURL();

			
			viewer.loadGUI(() => {
				viewer.setLanguage('en');
				$("#menu_appearance").next().show();
				$("#menu_tools").next().show();
				$("#menu_scene").next().show();
				viewer.toggleSidebar();
			});
			
				
		}
        
		function add_pointclouds_to_scene(cloud_fps, volume, measure, width) {
			console.log(cloud_fps);
            timer = setInterval(function() {
                if (viewer.scene.pointclouds.length > 0 && viewer.scene.volumes.length > 0) {
                    for (let p of viewer.scene.pointclouds) {
                        p.material.downsamplingEllipseMatrix = viewer.scene.volumes[0].matrixWorld.clone();
                    }
                }
                if (viewer.scene.pointclouds.length > 0 && viewer.scene.measurements.length > 0) {
                    for (let p of viewer.scene.pointclouds) {
                        p.material.downsamplingPolygon = viewer.scene.measurements[0].points; 
                    }
                } else {
                    for (let p of viewer.scene.pointclouds) {
                        p.material.downsamplingPolygon = null;
                    }
					
				}
            }, 500) ;
            
            cloud_fps.forEach(function (cloud_fp) {
                Potree.loadPointCloud(cloud_fp, cloud_fp, e => {
					console.log(cloud_fp);
                    let pointcloud = e.pointcloud;
                    let material = pointcloud.material;
                    viewer.scene.addPointCloud(pointcloud);
					// Set pointcloud material
					
					material.pointColorType = Potree.PointColorType.RGB;
					material.pointColorType = Potree.PointColorType.HEIGHT;
					material.elevationRange = [-1, 2];
					
                    material.size = 1;
                    material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
                    material.pointSizeType = Potree.PointSizeType.FIXED;
                    material.shape = Potree.PointShape.CIRCLE;
					
					viewer.fitToScreen();
					

                    // viewer.scene.pointclouds[0].material.downsamplingEllipseMatrix = viewer.scene.volumes[0].matrixWorld.clone()
                    material.downsamplingEllipseMatrix = volume.matrixWorld;
                    material.downsamplingWidth = width;
					material.downsamplingPolygon = measure.points; 
					
                    // [-0.18421298265457153,-2.2564060091972347,3.561807453632351,1.9097316861152667,-1.439433649182318,3.466807454824444,2.1407316923141497,0.5995248556137116,2.757821276783939,1.372745513916017,-0.06246131658553811,4.359779797494409,0.024773180484772173,-1.5844336524605735,4.531779795885083];
					setDebugShaderState(debugShaderState);
				});	
            });
		}
			
		// Create pyramids
		add_potree_viewer();

		function addPtcAndDownsamplingObjs(idx) {
			// TODO : REMOVE MEASUREMENTS AND VOLUMES
			for (let p of viewer.scene.pointclouds) {
				viewer.scene.scenePointCloud.children.pop();
			}
			viewer.scene.pointclouds = [];
			viewer.scene.removeAllMeasurements();

			// Ptc
			let cloud_fps;
			// VOLUME
			let volume  = new Potree.SphereVolume();
			// AREA MEASURE
			let measure = new Potree.Measure();
			measure.name = "Area";
			measure.closed = true;
			measure.showArea = false;
			measure.showDistances = false;
			measure.lengthUnit = {code: 'm', unitspermeter: '1'};
			measure.lengthUnitDisplay = {code: 'm', unitspermeter: '1'};
			console.log('loading dataset number ' + idx);
			switch (idx) {
				// case 0 is lion, default
				case 1: 
					cloud_fps = [
						"../pointclouds/vol_total/cloud.js"
					];
					// HEIDENTOR
					volume.scale.set(133, 133, 133);
					volume.position.set(589780, 231423., 751);
					width = 10;
					/*
					cloud_fps = [
						"http://3d.iconem.com/armenia/Geghard_681M/pointclouds/Exterior/cloud.js",
						"http://3d.iconem.com/armenia/Geghard_681M/pointclouds/Interior/cloud.js"
					];*/
					break;
				case 2: 
					// CRAC
					cloud_fps = [
						"http://localhost:8080/Syria/CracDesChevaliers/03_Deliverables/Potree/Crac_Unesco_final/Iconem_3D_Viewer_files/pointclouds/zone_DP/cloud.js",
						"http://localhost:8080/Syria/CracDesChevaliers/03_Deliverables/Potree/Crac_Unesco_final/Iconem_3D_Viewer_files/pointclouds/zone_East1/cloud.js",
						"http://localhost:8080/Syria/CracDesChevaliers/03_Deliverables/Potree/Crac_Unesco_final/Iconem_3D_Viewer_files/pointclouds/zone_East2/cloud.js",
						"http://localhost:8080/Syria/CracDesChevaliers/03_Deliverables/Potree/Crac_Unesco_final/Iconem_3D_Viewer_files/pointclouds/zone_HG_filter/cloud.js",
						"http://localhost:8080/Syria/CracDesChevaliers/03_Deliverables/Potree/Crac_Unesco_final/Iconem_3D_Viewer_files/pointclouds/zone_IM_1North/cloud.js",
						"http://localhost:8080/Syria/CracDesChevaliers/03_Deliverables/Potree/Crac_Unesco_final/Iconem_3D_Viewer_files/pointclouds/zone_IM_2South/cloud.js",
						"http://localhost:8080/Syria/CracDesChevaliers/03_Deliverables/Potree/Crac_Unesco_final/Iconem_3D_Viewer_files/pointclouds/zone_K/cloud.js",
						"http://localhost:8080/Syria/CracDesChevaliers/03_Deliverables/Potree/Crac_Unesco_final/Iconem_3D_Viewer_files/pointclouds/zone_North/cloud.js",
						"http://localhost:8080/Syria/CracDesChevaliers/03_Deliverables/Potree/Crac_Unesco_final/Iconem_3D_Viewer_files/pointclouds/zone_OHK/cloud.js",
						"http://localhost:8080/Syria/CracDesChevaliers/03_Deliverables/Potree/Crac_Unesco_final/Iconem_3D_Viewer_files/pointclouds/zone_South/cloud.js",
						"http://localhost:8080/Syria/CracDesChevaliers/03_Deliverables/Potree/Crac_Unesco_final/Iconem_3D_Viewer_files/pointclouds/zone_West/cloud.js",
					];
					// volume
					volume.scale.set(70, 70, 70.);
					volume.position.set(252411.519, 	3849412.677, 	717.810); 
					// measure
					measure.addMarker(new THREE.Vector3(252312.53670597076,3849289.745218277,691.6003189086914));
					measure.addMarker(new THREE.Vector3(252451.8246626854,3849299.777217865,669.4807281494141));
					measure.addMarker(new THREE.Vector3(252470.13377046585,3849503.4468689077,666.8055067062378));
					measure.addMarker(new THREE.Vector3(252385.46141076088,3849544.317322742,689.263959646225));
					measure.addMarker(new THREE.Vector3(252342.26259231567,3849430.3488788605,735.4059476852417));
					width = 10;
					break;
				case 3: 
					// MOSUL
					cloud_fps = [
						"http://localhost:8080/Irak/Mosul/2018-07/03-Delivrables/Potree/Mosul_3cm_Potree/NOVEMBER/Mosul_3cm_75m_potree/pointclouds/Mosul_3cm_october/cloud.js",
					];
					break;
				case 4: 
					// BAMIYAN
					cloud_fps = [
						"http://localhost:8080/pointclouds/bamiyan_cliff/cloud.js",
					];
					// volume
					volume.position.set(392348.669, 3854846.918, 10.208); 
					// measure
					measure.addMarker(new THREE.Vector3(391784.26355934143,3854505.6129131317,11.891416549682617));
					measure.addMarker(new THREE.Vector3(392441.18989372253,3854699.9914016724,7.633417129516602));
					measure.addMarker(new THREE.Vector3(393101.4833602905,3854829.5712738037,0.046417236328125));
					measure.addMarker(new THREE.Vector3(392951.89961242676,3855152.947248459,41.42341613769531));
					measure.addMarker(new THREE.Vector3(392264.36640548706,3855120.998374939, 112.83216094970703));
					measure.addMarker(new THREE.Vector3(391689.9568157196,3854853.233016968,90.04416072368622));
					width = 200;
					break;
				default: 
					cloud_fps = [
						"../pointclouds/lion_takanawa/cloud.js"
					];
					// volume
					volume.scale.set(2., 1., 3.);
					volume.position.set(1., -1., 5);
					// measure
					measure.addMarker(new THREE.Vector3(-0.18421298265457153,-2.2564060091972347,3.561807453632351));
					measure.addMarker(new THREE.Vector3(1.9097316861152667,-1.439433649182318,3.466807454824444));
					measure.addMarker(new THREE.Vector3(2.1407316923141497,0.5995248556137116,2.757821276783939));
					measure.addMarker(new THREE.Vector3(1.372745513916017,-0.06246131658553811,4.359779797494409));
					measure.addMarker(new THREE.Vector3(0.024773180484772173,-1.5844336524605735,4.531779795885083));
					width = 1.;
					break; 
			}

			volume.updateMatrixWorld();
			viewer.scene.addVolume(volume);
			viewer.scene.addMeasurement(measure);
			add_pointclouds_to_scene(cloud_fps, volume, measure, width);
			//viewer.fitToScreen();

			return [cloud_fps, volume, measure, width];
		}
		
		[cloud_fps, volume, measure, width] = addPtcAndDownsamplingObjs(datasetIdx++);
		
		timer = setInterval(function() {
			if (viewer.scene.pointclouds.length > 0 && viewer.scene.volumes.length > 0) {
				for (let ptc of viewer.scene.pointclouds) {
					ptc.material.downsamplingEllipseMatrix = viewer.scene.volumes[0].matrixWorld.clone();
				}
			}
		}, 500) ;

		var debugShaderState = false;
		function setDebugShaderState(debugShaderState) {
			for (let ptc of viewer.scene.pointclouds) {
				ptc.material.pointColorType = debugShaderState ? Potree.PointColorType.HEIGHT : Potree.PointColorType.RGB;
			}
		}
		function switchDebugShaderState() {
			debugShaderState = !debugShaderState;
			setDebugShaderState(debugShaderState);
		}
	</script>
	
	
  </body>
</html>
